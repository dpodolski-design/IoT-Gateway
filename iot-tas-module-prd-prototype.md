# PRD: Прототип модуля IoT-интеграции для TAS-платформы

**Версия:** 1.0  
**Дата:** 2025  
**Статус:** Черновик  
**Ссылка на архитектуру:** [iot-tas-module-architecture.md](./iot-tas-module-architecture.md)

---

## 1. Резюме документа

Настоящий PRD описывает требования к **прототипу** модуля IoT-интеграции для телеком-платформы (TAS) на базе Kamailio, FreeSWITCH и PostgreSQL. Цель прототипа — доказать жизнеспособность архитектуры и ключевых сценариев «телеком ↔ умный дом» в ограниченном объёме, с возможностью последующего расширения до промышленного решения.

---

## 2. Цели и границы прототипа

### 2.1 Цели

| Цель | Описание |
|------|----------|
| **Валидация архитектуры** | Подтвердить, что выбранная схема (IoT Gateway, адаптеры, Rules Engine, Device Registry) обеспечивает двунаправленную интеграцию без переработки ядра TAS. |
| **Демонстрация сценариев** | Реализовать минимум один сценарий «телеком → IoT» (звонок на колонку) и один «IoT → телеком» (датчик дыма → звонок) для показа заказчику и внутренним стейкхолдерам. |
| **Проверка стека** | Убедиться в совместимости интеграций с Kamailio, FreeSWITCH (ESL/REST), PostgreSQL в рамках одного стенда. |
| **Фундамент для продукта** | Заложить структуру кода, API и данных, пригодную для поэтапного наращивания функциональности (см. архитектуру, фазы 2–4). |

### 2.2 Границы прототипа (Scope)

**В рамках прототипа:**

- Один направление «телеком → IoT»: **входящий звонок → уведомление на умную колонку** (одна экосистема: например, только HTTP-уведомление на тестовый клиент или один вендор по согласованию).
- Один направление «IoT → телеком»: **событие «датчик дыма» → исходящий звонок на заданный номер** через FreeSWITCH.
- **Device Registry**: регистрация устройств (колонка, датчик дыма), привязка к номеру/подписчику.
- **Rules Engine (упрощённый)**: сопоставление типа события с одним действием (звонок на номер), без сложных условий и приоритетов.
- **REST API** модуля: регистрация устройств, приём webhook событий от умного дома, опционально — запрос «куда звонить при событии X».
- **Интеграция с FreeSWITCH**: порождение исходящего вызова по команде модуля (ESL или mod_commands/REST).
- **Интеграция с Kamailio**: опционально для прототипа — только если требуется маршрутизация входящего вызова на «IoT-подписчика»; иначе допустима имитация входящего вызова (например, через ESL/API FreeSWITCH).
- **PostgreSQL**: схема для Device Registry, правил (упрощённая), лог событий (таблица для аудита).

**Вне рамок прототипа (явно не делаем):**

- Входящая SMS на колонку.
- Домофон и умный браслет (сценарии фазы 3–4).
- Поддержка нескольких вендоров колонок и протоколов умного дома (Matter, Zigbee и т.д.) — только один упрощённый протокол (REST webhook).
- Полноценная аутентификация (OAuth2, JWT) — достаточно API key или простой токен в заголовке.
- Очереди (Kafka/RabbitMQ), идемпотентность, горизонтальное масштабирование.
- Production-мониторинг, метрики, алерты.
- Биллинг и CDR в полном объёме (достаточно логирования в БД для отладки).

---

## 3. Персоны и сценарии использования

### 3.1 Персоны

| Персона | Роль | Интерес в прототипе |
|---------|------|----------------------|
| **Оператор связи** | Владелец TAS, заказчик модуля | Убедиться, что звонки и события умного дома можно связать без переделки ядра. |
| **Разработчик платформы** | Интегратор TAS и IoT | Проверить интеграции с Kamailio/FreeSWITCH/PostgreSQL и удобство API. |
| **Владелец умного дома** | Конечный пользователь (косвенно) | Сценарии «звонок на колонку» и «дым → звонок» должны работать на стенде. |

### 3.2 Сценарии использования (Use Cases)

**UC-1: Входящий звонок → уведомление на умную колонку**

- **Актор:** абонент (звонящий), владелец колонки (получатель).
- **Предусловия:** устройство «умная колонка» зарегистрировано в Device Registry и привязано к номеру N; входящий вызов на номер N обрабатывается платформой (Kamailio/FreeSWITCH).
- **Основной поток:**  
  1) На номер N приходит входящий SIP-вызов.  
  2) TAS (или модуль по событию от FreeSWITCH/Kamailio) определяет, что N — IoT-подписчик.  
  3) Модуль по Device Registry находит устройство (колонка) для N и отправляет уведомление (REST/WebSocket) на колонку: «входящий вызов, CLI = X».  
  4) Колонка воспроизводит рингтон и/или отображает CLI (в прототипе — тестовый клиент может логировать событие).
- **Постусловие:** вызов может быть принят с телефона или с колонки (принятие с колонки — опционально в прототипе).

**UC-2: Датчик дыма → звонок на указанный номер**

- **Актор:** система умного дома (датчик/хаб), владелец (получатель звонка).
- **Предусловия:** устройство «датчик дыма» зарегистрировано; для типа события `smoke` задано правило «позвонить на номер M».
- **Основной поток:**  
  1) Умный дом отправляет в модуль webhook: событие `smoke`, device_id.  
  2) Модуль проверяет токен/подпись (упрощённо), находит устройство и правило.  
  3) Rules Engine формирует действие: «инициировать звонок на M».  
  4) Модуль через FreeSWITCH (ESL/REST) инициирует исходящий вызов на M (при необходимости — с воспроизведением голосового предупреждения).  
  5) Событие и результат логируются в БД.
- **Постусловие:** абонент M получает звонок; в логе есть запись о срабатывании.

---

## 4. Функциональные требования

### 4.1 Device Registry

| ID | Требование | Приоритет |
|----|------------|-----------|
| FR-DR-1 | Хранение устройств: `device_id`, `type` (speaker, sensor_smoke), `subscriber_id` или `msisdn`, `vendor`, `endpoint` (URL или идентификатор), `metadata` (JSON). | Must |
| FR-DR-2 | API: создание/обновление/удаление устройства (REST). | Must |
| FR-DR-3 | API: получение устройства по `device_id`, получение устройств по `msisdn` или `subscriber_id`. | Must |
| FR-DR-4 | Для прототипа — один колонка и один датчик дыма на один номер/подписчика достаточно. | Should |

### 4.2 Правила (Rules) — упрощённая модель

| ID | Требование | Приоритет |
|----|------------|-----------|
| FR-R-1 | Хранение правил: `event_type` (например, `smoke`), `device_id` или привязка к типу устройства, `action_type` (e.g. `call`), `target` (номер для звонка). | Must |
| FR-R-2 | API: создание/обновление/удаление правила. | Must |
| FR-R-3 | При приходе события модуль находит подходящее правило и выполняет действие (звонок). Один тип события — одно правило (без приоритетов). | Must |

### 4.3 Телеком → IoT (входящий звонок на колонку)

| ID | Требование | Приоритет |
|----|------------|-----------|
| FR-TI-1 | Получение события «входящий вызов»: от FreeSWITCH (ESL) или от тестового REST-вызова модуля с параметрами `to_msisdn`, `from_cli`. | Must |
| FR-TI-2 | По `to_msisdn` определение устройства типа «колонка» из Device Registry. | Must |
| FR-TI-3 | Отправка уведомления на устройство (HTTP POST на `endpoint` устройства или вызов внутреннего тестового обработчика). Формат: минимум `event: incoming_call`, `from_cli`, `call_id`. | Must |
| FR-TI-4 | Логирование события в таблицу логов (опционально привязка к CDR в прототипе не обязательна). | Should |

### 4.4 IoT → Телеком (датчик дыма → звонок)

| ID | Требование | Приоритет |
|----|------------|-----------|
| FR-IT-1 | REST endpoint для приёма webhook: POST с телом `event_type`, `device_id`, опционально `timestamp`, `payload`. | Must |
| FR-IT-2 | Проверка подлинности: API key или токен в заголовке (простая проверка на равенство конфигу). | Must |
| FR-IT-3 | По `event_type` и `device_id` поиск правила с действием `call` и целевым номером. | Must |
| FR-IT-4 | Вызов FreeSWITCH (ESL или REST mod_commands) для создания исходящего вызова на целевой номер. | Must |
| FR-IT-5 | При возможности — воспроизведение короткого аудио «Внимание, сработал датчик дыма» (файл на FreeSWITCH или TTS — опционально). | Could |
| FR-IT-6 | Запись в таблицу логов: event_type, device_id, rule_id, target_number, result (success/failure), timestamp. | Must |

### 4.5 Интеграция с FreeSWITCH

| ID | Требование | Приоритет |
|----|------------|-----------|
| FR-FS-1 | Инициирование исходящего вызова: передача в FreeSWITCH номера назначения и опционально скрипта/application (playback, bridge). | Must |
| FR-FS-2 | Для прототипа достаточно одного способа: ESL (Outbound или Inbound) или REST (originate). | Must |
| FR-FS-3 | Обработка ответа FreeSWITCH (успех/ошибка) и отражение в логе модуля. | Should |

### 4.6 Интеграция с Kamailio (опционально в прототипе)

| ID | Требование | Приоритет |
|----|------------|-----------|
| FR-K-1 | Если в прототипе входящий вызов приходит через существующий TAS: способ передать в модуль факт входящего вызова на номер N (например, скрипт в Kamailio вызывает HTTP callback модуля или запись в БД, которую читает модуль). | Could |
| FR-K-2 | Альтернатива: имитация входящего вызова через REST API модуля «симуляция входящего на номер N» для демо. | Must (если Kamailio не интегрируется в срок) |

### 4.7 Логирование и аудит

| ID | Требование | Приоритет |
|----|------------|-----------|
| FR-L-1 | Таблица (или одна общая) логов: тип события (incoming_call_notify, smoke_trigger_call), идентификаторы (device_id, rule_id, call_id), результат, timestamp. | Must |
| FR-L-2 | Доступ к логам через REST API (список последних N записей) — для отладки и демо. | Should |

---

## 5. Нефункциональные требования (прототип)

| ID | Требование | Комментарий |
|----|------------|-------------|
| NFR-1 | Язык/стек реализации — на усмотрение команды (Python/Node/Go и т.д.), с возможностью вызова ESL и HTTP. | Прототип. |
| NFR-2 | Конфигурация: БД (PostgreSQL), URL FreeSWITCH, секрет для webhook — через переменные окружения или конфиг-файл. | Без сложного vault. |
| NFR-3 | Запуск на одном стенде: модуль + PostgreSQL; Kamailio/FreeSWITCH — существующие или демо-стенд. | Не требуется кластер. |
| NFR-4 | Документация: README с описанием запуска, примеры запросов к REST API и пример тела webhook. | Минимум для передачи. |
| NFR-5 | Безопасность: только TLS по возможности; API key в заголовке для webhook и при необходимости для админ-API. | Production-безопасность — вне прототипа. |

---

## 6. Зависимости и ограничения

- **Зависимости:** доступ к экземпляру PostgreSQL; доступ к FreeSWITCH с включённым ESL или REST API (mod_commands); при интеграции с TAS — доступ к Kamailio и понимание маршрутизации входящих вызовов.
- **Ограничения:** прототип не предназначен для нагрузки и высокой доступности; один вендор/один протокол умного дома; упрощённые правила без приоритетов и сложных условий.

---

## 7. Критерии приёмки и успеха прототипа

### 7.1 Критерии приёмки

1. Устройства типа «колонка» и «датчик дыма» можно зарегистрировать и привязать к номеру/правилу через REST API.
2. При имитации входящего вызова на этот номер модуль отправляет уведомление на зарегистрированное устройство (или тестовый клиент).
3. При отправке webhook «событие smoke» от имени зарегистрированного датчика модуль находит правило и инициирует звонок через FreeSWITCH на заданный номер; звонок доходит до абонента.
4. Все срабатывания фиксируются в БД (логи).
5. README и примеры запросов позволяют запустить сценарии на новом окружении за разумное время (например, в пределах 1 дня).

### 7.2 Критерии успеха прототипа

- Архитектура из [iot-tas-module-architecture.md](./iot-tas-module-architecture.md) подтверждена: разделение на Gateway, адаптеры, Rules Engine, Device Registry — реализуемо и не упирается в TAS.
- Потоки «входящий звонок → колонка» и «дым → звонок» работают на стенде и могут быть продемонстрированы.
- Команда готова сформировать план перехода от прототипа к фазам 2–4 архитектуры (SMS, домофон, браслет, очереди, мониторинг).

---

## 8. Риски и допущения

| Риск | Вероятность | Митигация |
|------|-------------|-----------|
| Несовместимость версий FreeSWITCH/ESL с выбранным клиентом | Средняя | Закрепить версию FreeSWITCH и тестировать ESL/REST на раннем этапе. |
| Отсутствие реальной умной колонки для теста | Низкая | Заменить тестовым HTTP-сервером, принимающим уведомления и логирующим их. |
| Задержки из-за доступа к TAS (Kamailio) | Средняя | Реализовать симуляцию входящего вызова через REST и подключить Kamailio в следующей итерации. |

**Допущения:**

- PostgreSQL и FreeSWITCH доступны на стенде или могут быть развёрнуты (в т.ч. в Docker).
- Требования к формату webhook и полям Device Registry могут уточняться в процессе без изменения общей архитектуры.
- Прототип не подлежит сертификации и не заменяет production-решение по безопасности и надёжности.

---

## 9. Связь с архитектурой и дальнейшее развитие

- Прототип покрывает **Фазу 1** и часть **Фазы 2** из раздела «Последовательность внедрения» архитектурного документа.
- После приёмки прототипа планируемые следующие шаги: входящая SMS на колонку, сценарий домофона, затем носимые устройства и расширение протоколов (Matter и др.), а также введение очередей, полноценной аутентификации и мониторинга согласно разделу 4 архитектуры.

---

*Документ подготовлен на основе [iot-tas-module-architecture.md](./iot-tas-module-architecture.md) и предназначен для оценки объёма работ и планирования спринта/итерации по созданию прототипа.*
