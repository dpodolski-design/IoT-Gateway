# Архитектура и технические требования модуля IoT-интеграции для TAS-платформы

## 1. Цели и границы модуля

**Назначение:** единый модуль платформы TAS, который:
- интегрирует умный дом и телеком (двунаправленно);
- обеспечивает приём звонков и SMS на устройства умного дома (в т.ч. умные колонки);
- обрабатывает события умного дома и инициирует телеком-действия (звонки, SMS, уведомления).

**Внешние системы:** умные колонки, датчики (дым, проникновение), домофоны, носимые устройства (браслеты), шлюзы/хабы умного дома (Matter, Zigbee, протоколы вендоров).

---

## 2. Высокоуровневая архитектура

```
                    ┌─────────────────────────────────────────────────────────────┐
                    │                    TAS Platform (existing)                  │
                    │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
                    │  │  Kamailio   │  │ FreeSWITCH  │  │     PostgreSQL      │  │
                    │  │  (SIP/Routing)│  │(Media/IVR) │  │  (subscribers, CDR) │  │
                    │  └──────┬──────┘  └──────┬──────┘  └──────────┬──────────┘  │
                    └─────────┼────────────────┼────────────────────┼─────────────┘
                              │                │                    │
                              ▼                ▼                    ▼
                    ┌─────────────────────────────────────────────────────────────┐
                    │              IoT Integration Module (new)                    │
                    │  ┌───────────────────────────────────────────────────────┐  │
                    │  │              IoT Gateway / API Layer                   │  │
                    │  │  - REST/WebSocket API   - Webhook receiver             │  │
                    │  │  - Event subscription   - Command dispatch             │  │
                    │  └───────────────────────────────────────────────────────┘  │
                    │  ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐    │
                    │  │ Telekom →   │ │ IoT →       │ │ Rules & Scenarios    │    │
                    │  │ IoT Adapter │ │ Telekom     │ │ Engine               │    │
                    │  │ (call/SMS)  │ │ Adapter     │ │ (routing, triggers)  │    │
                    │  └─────────────┘ └─────────────┘ └─────────────────────┘    │
                    │  ┌───────────────────────────────────────────────────────┐  │
                    │  │           Device Registry & Mapping (DB)               │  │  │
                    │  └───────────────────────────────────────────────────────┘  │
                    └─────────────────────────────────────────────────────────────┘
                                          │
              ┌────────────────────────────┼────────────────────────────┐
              ▼                            ▼                            ▼
     ┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐
     │ Smart speakers   │       │ Sensors /       │       │ Doorphones,     │
     │ (Alexa, Google,  │       │ Smart home hubs │       │ Wearables       │
     │  custom)         │       │ (Matter, etc.)  │       │ (bracelets)     │
     └─────────────────┘       └─────────────────┘       └─────────────────┘
```

- **TAS (Kamailio + FreeSWITCH + PostgreSQL)** остаётся источником абонентских данных, маршрутизации и медиа.
- **Модуль IoT** — отдельный слой между TAS и миром умного дома: приём событий, правила, вызов телеком-функций (звонок, SMS) и доставка звонков/SMS на устройства.

---

## 3. Функциональные блоки модуля

### 3.1 Телеком → IoT (звонки и SMS на умный дом)

| Требование | Описание |
|------------|----------|
| **Идентификация устройства** | Сопоставление MSISDN/номера с устройством умного дома (колонка, экран) в Device Registry. |
| **Доставка входящего вызова** | При входящем SIP-вызове Kamailio/логика TAS определяет «IoT-подписчика» → модуль уведомляет колонку (push/WebSocket/API вендора) → колонка может воспроизвести рингтон, показать CLI, принять команду «ответить» и отдать обратно в FreeSWITCH. |
| **Доставка SMS** | При приходе SMS (через SMSC/интеграцию платформы) модуль по номеру находит устройство и передаёт текст/уведомление на колонку или экран. |
| **Единый номер / мультидевайс** | Один номер может быть привязан к нескольким устройствам (например, колонка + телефон); политика (одновременный звонок, fallback) задаётся правилами. |

Технически: событие «входящий вызов»/«входящая SMS» из TAS (через Event Socket/API/БД или Kafka) → IoT Gateway → адаптер «Телеком → IoT» → вызов API колонки или шлюза умного дома.

### 3.2 IoT → Телеком (обратные сценарии)

| Сценарий | Триггер | Действие телеком |
|----------|---------|-------------------|
| **Датчик дыма** | Событие «smoke detected» от шлюза/датчика | Немедленный звонок на заданные номера (владелец, МЧС), при необходимости голосовое сообщение (IVR/FreeSWITCH). |
| **Домофон** | Событие «doorbell» / «call from doorphone» | Инициация исходящего вызова с домофона на номер абонента (или на колонку в квартире) через FreeSWITCH; при ответе — аудио/видео с домофона. |
| **Умный браслет** | Событие «fall», «SOS», «heart anomaly» и т.п. | Звонок/SMS на экстренные контакты, при необходимости запись в CDR и передача в BSS/CRM. |

Общий поток: устройство/хаб отправляет событие в IoT Gateway (REST/webhook) → Rules Engine сопоставляет тип события и правила → Adapter «IoT → Телеком» вызывает Kamailio/FreeSWITCH (или внутренний API TAS) для создания звонка/SMS.

---

## 4. Технические требования

### 4.1 Интеграция с существующим стеком

| Компонент | Роль | Требования к интеграции |
|-----------|-----|--------------------------|
| **Kamailio** | Маршрутизация SIP, диалоги | Вызов из модуля: исходящий SIP (домофон → абонент), маршрутизация входящих на «виртуального абонента» IoT (далее обработка в модуле). Доступ к данным подписчика (в т.ч. привязка номера к устройству) через DB (PostgreSQL) или API. |
| **FreeSWITCH** | Медиа, IVR, исходящие/входящие вызовы | Event Socket (ESL) или REST API: порождение исходящих вызовов по команде модуля (домофон, датчик), воспроизведение приветствий/предупреждений (датчик дыма), конференция домофон–абонент. Входящий вызов на колонку может приходить как на обычный SIP-юзер-агент, которым управляет модуль. |
| **PostgreSQL** | Подписчики, CDR, конфигурация | Новые/расширенные таблицы: Device Registry (device_id, type, subscriber_id, vendor, endpoint, credentials_hash), Rules (event_type, conditions, actions, target numbers), CDR/логи событий IoT для биллинга и аудита. |

### 4.2 IoT Gateway (новый компонент)

- **API:** REST + опционально WebSocket для real-time уведомлений колонок.
- **Входящие события:** приём webhook от умного дома (Matter, Tuya, Home Assistant, нативные API вендоров) с проверкой подписи/токена.
- **Исходящие команды:** вызов API умных колонок (Amazon Alexa Smart Home, Google Home, или протокол оператора) для «звонок на колонку», «показать SMS», «ответить/завершить».
- **Масштабирование:** stateless, горизонтальное масштабирование за балансировщиком; состояние в PostgreSQL (или кэш в Redis).

### 4.3 Безопасность

- Аутентификация и авторизация всех вызовов API (OAuth2/API key/JWT), отдельные роли для устройств и для администрации.
- Шифрование каналов (TLS), не хранить пароли устройств в открытом виде (только хэши или ссылки на secure vault).
- Валидация и санитизация входящих webhook (подпись, nonce, лимиты частоты) для защиты от подделки событий (ложные «дым», «SOS»).
- Сетевой изоляция: модуль в DMZ или отдельном сегменте с жёсткими правилами доступа к Kamailio/FreeSWITCH и PostgreSQL.

### 4.4 Надёжность и эксплуатация

- Идемпотентность обработки событий (повторная доставка webhook не должна дублировать звонки/SMS).
- Очереди (например, RabbitMQ/Kafka) между приёмом событий и выполнением правил — для сглаживания пиков и повторных попыток.
- Логирование всех событий IoT и телеком-действий (в т.ч. в CDR) для расследований и биллинга.
- Мониторинг: метрики (число событий по типу, задержки, ошибки вызова FreeSWITCH/Kamailio), алерты при сбоях адаптеров или недоступности TAS.

### 4.5 Данные и модель правил

- **Device Registry:** идентификатор устройства, тип (speaker, sensor_smoke, doorphone, wearable), id подписчика (или номера), vendor, endpoint URL, id в системе умного дома, метаданные (комната, зона).
- **Правила (Rules):** тип события (smoke, doorbell, sos, incoming_call, incoming_sms), условия (время, зона, подписчик), действия (call numbers, send_sms, notify_device), приоритет, активность.
- **Маппинг номеров:** какой номер при входящем вызове/SMS считать «IoT-номером» и какое устройство уведомлять (в т.ч. для мультидевайса).

---

## 5. Последовательность внедрения (рекомендация)

1. **Фаза 1:** Device Registry + API Gateway + базовый сценарий «входящий звонок → уведомление на умную колонку» (одна экосистема, например только Alexa или только Google).
2. **Фаза 2:** Входящая SMS на колонку; сценарий «датчик дыма → звонок на номера».
3. **Фаза 3:** Домофон (звонок с домофона на абонента/колонку через FreeSWITCH).
4. **Фаза 4:** Носимые устройства (браслет), расширение правил и протоколов умного дома (Matter, другие хабы).

---

## 6. Краткий чек-лист технических требований

- Интеграция с Kamailio (SIP-маршрутизация, доступ к данным подписчика).
- Интеграция с FreeSWITCH (ESL/REST: создание вызовов, IVR, конференции).
- Расширение схемы PostgreSQL (Device Registry, Rules, логирование событий).
- REST/WebSocket API для устройств и партнёров.
- Приём webhook от умного дома с проверкой подлинности.
- Адаптеры под умные колонки (хотя бы один вендор на старте).
- Rules Engine для сопоставления событий и действий (телеком ↔ IoT).
- Безопасность (TLS, аутентификация, не хранить секреты в открытом виде).
- Очереди и идемпотентность для надёжной обработки событий.
- Логирование и метрики для эксплуатации и биллинга.
