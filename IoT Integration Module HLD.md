## 1) Цель модуля и границы ответственности

**IoT Integration Module (IIM)** — модуль сервисной платформы оператора, обеспечивающий двустороннюю интеграцию между телеком-сервисами (TAS/Kamailio/FreeSWITCH/SMS) и экосистемами умного дома:

- **Телеком → умный дом**
  - входящие **звонки** и **SMS** с доставкой на “умные колонки/хабы” (и/или связанные приложения/домашние панели),
  - озвучивание/уведомления, “звонок в дом”, внутренние сценарии (например, “прочитать SMS”, “принять вызов в комнате”).
- **Умный дом → телеком**
  - события от устройств (**датчик дыма**, **домофон**, **умный браслет**) инициируют телеком-действия: вызов, SMS, автодозвон по эскалации, IVR/робот, уведомления группе и т. п.

> Важно: реальные “умные колонки” часто **не поддерживают SIP** напрямую. Поэтому архитектура должна поддержать **2 модели интеграции**:
> 1) **SIP/WebRTC endpoint** (если колонка/хаб/домашний шлюз поддерживает SIP/WebRTC).
> 2) **Cloud-to-Cloud** через API/Skill экосистем (колонка звонит/говорит через облако вендора, а не как SIP-абонент).

---

## 2) Архитектура (логические компоненты)

### 2.1. Высокоуровневая схема

```text
                      +-------------------------------+
                      |       Operator Platform       |
                      |                               |
PSTN/IMS/SMSC <-----> |  TAS <-> Kamailio <-> FS      |
                      |        (SIP)      (Media)     |
                      |   SMSC/SMPP/HTTP API          |
                      +-------------------------------+
                                  |
                                  | (Internal APIs / SIP / ESL / HTTP)
                                  v
+---------------------------------------------------------------------+
|                        IoT Integration Module (IIM)                 |
|                                                                     |
|  [1] IoT API Gateway / Ingress  <---- Webhooks / REST / MQTT        |
|  [2] Device & Account Registry  <---- PostgreSQL                    |
|  [3] Identity & Consent         <---- OAuth2/OIDC, mTLS, RBAC       |
|  [4] Event Bus / Queue          <---- Kafka/RabbitMQ (рекоменд.)    |
|  [5] Rules Engine / Orchestrator <--- сценарии/эскалации/таймеры    |
|  [6] Telephony Adapter          <---- SIP to Kamailio, ESL to FS    |
|  [7] Messaging Adapter          <---- SMPP/HTTP to SMSC             |
|  [8] Smart Home Connectors      <---- Alexa/Google/…/OEM APIs       |
|  [9] Notification/TTS/ASR       <---- TTS (внутр./внешн.), prompts  |
| [10] Observability & Audit      <---- logs/metrics/traces/audit     |
+---------------------------------------------------------------------+
                                  |
                                  v
                     +------------------------------+
                     | Smart Home Ecosystems/Devices|
                     | speakers, hubs, sensors, ... |
                     +------------------------------+
```

### 2.2. Встраивание в текущий стек (Kamailio/FreeSWITCH/PostgreSQL)

- **Kamailio**: маршрутизация SIP, WebSocket/SIP для WebRTC клиентов, политика (ACL/rate-limit), SIP-registrar при необходимости.
- **FreeSWITCH**: медиа (DTLS-SRTP/WebRTC, RTP), IVR, проигрывание/запись, конференции, TTS-пайплайн (через mod_unimrcp/mod_tts/HTTP TTS), исходящие обзвоны, bridge.
- **PostgreSQL**: хранение реестра устройств/аккаунтов, связок “абонент ↔ дом ↔ устройство”, политики, consent, ключей/сертификатов (метаданные), шаблонов сценариев.
- **IIM Telephony Adapter**:
  - управление вызовами через **ESL (Event Socket)** FreeSWITCH и/или через внутренние API TAS,
  - SIP-инициация через Kamailio (если требуется), либо напрямую в FS (в зависимости от вашей существующей архитектуры TAS).

---

## 3) Ключевые функции модуля

### 3.1. Device/Account Binding (привязка)
- Привязка абонента (MSISDN/SIP AoR/учётка оператора) к:
  - “дому/локации”,
  - устройствам (колонки/хабы/сенсоры),
  - внешним облачным аккаунтам (через OAuth2 авторизацию экосистемы).
- Модель владения: **multi-tenant** (оператор → бренд/регион → домохозяйство → пользователи → устройства).

### 3.2. Телеком → Умный дом
- **Входящий звонок**:
  - маршрутизация по правилам: звонить на телефон, параллельно на дом, только на дом, “тихий режим” и т. п.
  - доставка “звонка” на умную колонку:
    - **SIP/WebRTC-режим**: колонка/хаб как endpoint (SIP/WebRTC), FS делает bridge.
    - **Cloud-режим**: IIM вызывает API/skill экосистемы: “announce incoming call”, “prompt accept/decline”, затем либо:
      - устанавливает медиа через WebRTC/SIP (если поддерживается),
      - либо запускает **интерактивный голосовой сценарий** (например, “соединить с телефоном владельца”, “принять сообщение”).
- **Входящий SMS**:
  - доставка текста в умный дом:
    - озвучивание (TTS),
    - показ на панели/приложении (если есть),
    - политики приватности: “озвучивать только от избранных”, “только когда дома”, “только ночью запрещено”.

### 3.3. Умный дом → Телеком (обратные сценарии)
- События датчиков и устройств:
  - **Smoke/CO**: немедленный звонок владельцу + SMS, затем эскалация (второй контакт, охрана, сервис), подтверждение “ложная тревога”.
  - **Домофон**: вызов на группу (телефон + дом), при отсутствии ответа — автоответчик/запись/уведомление.
  - **Умный браслет**: падение/пульс — обзвон по сценарию, возможно “проверка связи” (IVR), при подтверждении — звонок в экстренные контакты (с учётом регуляторики).
- Поддержка **эскалаций, дедлайнов, ретраев, дедупликации** событий.

---

## 4) Интерфейсы и протоколы

### 4.1. Northbound (к умному дому)
- **Webhook/REST** для OEM/агрегаторов (с обязательным mTLS и подписью запросов).
- **MQTT** (опционально): для локальных хабов/шлюзов (mTLS, client certs).
- **Cloud Connectors**:
  - OAuth2/OIDC (Authorization Code + PKCE),
  - подписанные события (HMAC/JWS),
  - ограничение scope (“read events”, “send notifications”, “voice interaction”).

### 4.2. Southbound (к телеком-платформе)
- **SIP** (через Kamailio) для маршрутизации/форкинга/переадресаций.
- **ESL** к FreeSWITCH для управления вызовами/IVR/конференциями.
- **SMSC**: SMPP/HTTP API для SMS/Flash SMS/Delivery Receipts.
- Внутренние API TAS: подписка на события вызовов/смс, управление сервисной логикой.

---

## 5) Потоки (примеры)

### 5.1. Входящий звонок → умная колонка (SIP/WebRTC endpoint)
```text
Caller -> IMS/PSTN -> TAS -> (lookup policies in IIM) -> Kamailio -> FreeSWITCH
  FreeSWITCH forks:
    a) to MSISDN (обычно)
    b) to SmartSpeaker SIP/WebRTC endpoint (DTLS-SRTP)
  Answer on speaker -> bridge -> call connected
```

### 5.2. Входящий SMS → озвучивание на колонке (cloud notification)
```text
SMSC -> TAS -> IIM (policy: allowed sender/time/presence) ->
SmartHome Connector -> push "new message" ->
Device plays TTS (or IIM generates TTS and provides audio URL if ecosystem supports)
```

### 5.3. Датчик дыма → эскалационный обзвон
```text
Sensor -> Hub/Cloud -> IIM Ingress -> Event Bus -> Rules Engine:
  1) Place call to owner (FS outbound)
  2) If no answer -> SMS + call backup contact
  3) If confirmed -> create incident + notify additional channels
```

---

## 6) Данные и модель хранения (PostgreSQL)

Минимальные сущности:

- `tenant` / `brand` / `region`
- `subscriber` (MSISDN, SIP AoR, internal user id)
- `household` / `location`
- `device` (type: speaker/hub/sensor/wearable/doorphone; vendor; capabilities; identifiers)
- `binding` (subscriber↔household↔device)
- `consent` (кто кому может звонить/что озвучивать; сроки; revocation)
- `policy` (quiet hours, do-not-disturb, allowed senders, presence rules)
- `scenario` / `rule` (trigger → actions → escalation)
- `credential_ref` (ссылки на секреты/токены в хранилище секретов; не хранить plaintext)
- `audit_log` (неизменяемый журнал действий/доступов)

---

## 7) Нефункциональные требования (NFR)

### 7.1. Производительность и задержки
- Время реакции на IoT-событие до начала вызова: целевое \(< 1\text{–}2\) сек (без учёта установления вызова).
- Входящий звонок: добавленная задержка маршрутизации IIM: \(< 50\text{–}100\) мс на policy/lookup.
- Масштабирование:
  - горизонтальное для ingress/rules/connectors,
  - отдельное масштабирование для медиа (FS).

### 7.2. Надёжность
- HA минимум N+1 для всех stateless сервисов IIM.
- Очередь/шина событий с persistence и ретраями.
- Идемпотентность обработчиков (по `event_id` + дедупликация).
- Деградация:
  - если smart home недоступен — fallback на обычный телефон/SMS,
  - если TTS недоступен — fallback на текстовое уведомление (где возможно).

### 7.3. Наблюдаемость
- Метрики: успешность доставок/звонков, latency, ретраи, ошибки по коннекторам, rate-limit hits.
- Трассировка: корреляция `call_id`/`sms_id`/`event_id`.
- Аудит: кто включил сценарий, кто предоставил consent, кто прочитал/озвучил SMS.

---

## 8) Безопасность (обязательно)

### 8.1. Модель угроз (ключевые)
- Подмена IoT-событий (ложный “дым” → обзвон/паника).
- Перехват токенов экосистемы (контроль над домом/уведомлениями).
- Несанкционированное озвучивание приватных SMS/контента.
- DDoS через публичные webhook’и/IoT endpoints.
- Атаки на SIP/медиа (registration hijack, toll fraud, RTP injection).
- Внутренние злоупотребления (оператор/админ).

### 8.2. Технические меры
**Идентификация и аутентификация**
- Для устройств/шлюзов: **mTLS с клиентскими сертификатами**, ротация, CRL/OCSP (или short-lived certs).
- Для облачных интеграций: OAuth2/OIDC, хранение refresh-токенов в защищённом secret store, ограничение scope.
- Для внутренних вызовов: mTLS + сервисные аккаунты + RBAC.

**Авторизация и consent**
- Явный consent на:
  - озвучивание SMS,
  - уведомления по входящим вызовам,
  - обработку чувствительных датчиков (health).
- Политики приватности: “озвучивать только при присутствии дома/по голосовому PIN/voice match (если экосистема поддерживает)”.

**Защита контента**
- Шифрование в транзите: TLS 1.2+ (лучше 1.3).
- Шифрование at-rest: PostgreSQL TDE/диск + шифрование полей (секреты не хранить в БД).
- Для медиа: SRTP (DTLS-SRTP для WebRTC), строгие cipher suites.

**Защита SIP/телефонии**
- Anti-fraud: лимиты на исходящие, whitelist направлений для сценариев, скоринг аномалий.
- SIP hardening: ACL, fail2ban/iptables, rate limit на регистрациях/INVITE, запрет открытого релея.
- Подпись/проверка источника событий сценариев перед вызовом (чтобы IoT не мог напрямую “заказывать” платные вызовы без политики).

**Валидация входящих событий**
- Подпись событий (JWS/HMAC) + nonce + защита от replay.
- Схемы данных (JSON schema), строгая типизация.
- Дедупликация и throttling (особенно для “шумных” датчиков).

**Изоляция и multitenancy**
- Логическая изоляция данных по tenant (row-level security или отдельные схемы/БД).
- Отдельные ключи шифрования на tenant (KMS).

**Аудит и соответствие**
- Неподменяемый аудит (append-only), хранение сроков.
- Политики хранения контента (SMS текст, транскрипты, записи вызовов) — минимизация, срок, право на удаление (если применимо).
- Учет требований lawful intercept/регуляторики (в зависимости от страны) — заранее предусмотреть точки интеграции, но ограничить доступ.

---

## 9) Технические требования к модулю (минимальный “Definition of Done”)

### 9.1. Функциональные
1. Реестр устройств/домов/привязок и API управления.
2. Движок сценариев:
   - триггеры (call/sms/iot event),
   - действия (call, sms, push notify, tts announce),
   - условия (время, отправитель, presence, статус устройства),
   - эскалации и ретраи.
3. Интеграция с TAS/Kamailio/FreeSWITCH:
   - подписка на события звонка (incoming, answer, hangup),
   - инициирование исходящих вызовов/bridge,
   - SMPP/HTTP отправка SMS.
4. Коннекторы smart home:
   - минимум 1 “универсальный” (webhook/REST для OEM gateway),
   - архитектурная готовность к добавлению коннекторов под конкретные экосистемы (плагинный подход).
5. Политики приватности и consent.
6. Админка/операторские инструменты (минимум API + CLI): управление tenant’ами, просмотр статусов коннекторов, тестовый вызов/уведомление.

### 9.2. Нефункциональные
- HA, горизонтальное масштабирование, идемпотентность.
- Observability (metrics/logs/traces) + аудит.
- Security baseline (mTLS, OAuth2, RBAC, secret management, rate limits).
- Fallback-логика при недоступности smart home.

---

## 10) Рекомендации по реализации (практично)

- Делать IIM **event-driven**: входящие события (SIP/SMS/IoT) → шина → rules → адаптеры.
- Коннекторы smart home — **плагинные** (единый внутренний контракт: `send_notification`, `request_user_action`, `deliver_tts`, `receive_event`).
- FreeSWITCH использовать как “execution engine” для голосовых сценариев (IVR/обзвон/bridge), а IIM — как оркестратор (кто/когда/по каким правилам).
- Не пытаться “натянуть SIP на колонку”, если экосистема этого не даёт: закладывать cloud-to-cloud уведомления и интерактивные сценарии через официальные API.

